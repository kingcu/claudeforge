{"id":"claudeforge-0aa","title":"Create server Dockerfile for containerization","description":"Create Dockerfile for containerizing the server.\n\n**Context**: Server runs in Docker for easy deployment and isolation.\n\n**Dockerfile** (see plan lines 1319-1341):\n```dockerfile\nFROM python:3.12-slim\n\nWORKDIR /app\n\n# Install curl for healthcheck\nRUN apt-get update \u0026\u0026 apt-get install -y curl \u0026\u0026 rm -rf /var/lib/apt/lists/*\n\n# Copy and install\nCOPY pyproject.toml .\nCOPY src/ src/\nRUN pip install --no-cache-dir .\n\n# Security: non-root user\nRUN useradd -m appuser \u0026\u0026 chown -R appuser:appuser /app\nUSER appuser\n\nEXPOSE 8000\n\nCMD [\"uvicorn\", \"forgeserver.main:app\", \"--host\", \"0.0.0.0\", \"--port\", \"8000\"]\n```\n\n**Design decisions**:\n- python:3.12-slim for small image size\n- curl installed for Docker healthcheck\n- pip --no-cache-dir reduces image size\n- Non-root user (appuser) for security\n- Port 8000 exposed (mapped to 8420 in compose)\n\n**Success criteria**:\n1. `docker build -t forgeserver ./server` succeeds\n2. Image size \u003c 200MB\n3. `docker run -e FORGE_API_KEY=test -p 8000:8000 forgeserver` starts\n4. `curl localhost:8000/health` returns healthy\n5. Container runs as non-root (verify with `docker exec ... whoami`)\n","status":"closed","priority":2,"issue_type":"task","assignee":"epic:claudeforge-central","created_at":"2026-01-08T13:46:59.700341079-08:00","created_by":"kingcu","updated_at":"2026-01-08T16:06:35.928886432-08:00","closed_at":"2026-01-08T16:06:35.928886432-08:00","close_reason":"Created Dockerfile and comprehensive test suites","dependencies":[{"issue_id":"claudeforge-0aa","depends_on_id":"claudeforge-68x","type":"parent-child","created_at":"2026-01-08T13:47:07.163661077-08:00","created_by":"kingcu"},{"issue_id":"claudeforge-0aa","depends_on_id":"claudeforge-sn8","type":"blocks","created_at":"2026-01-08T13:47:07.215950759-08:00","created_by":"kingcu"},{"issue_id":"claudeforge-0aa","depends_on_id":"claudeforge-mcz","type":"blocks","created_at":"2026-01-08T13:47:07.268687147-08:00","created_by":"kingcu"}]}
{"id":"claudeforge-0lk","title":"Implement Click CLI commands (cli.py)","description":"Create Click CLI with all user-facing commands.\n\n**Context**: This is the main entry point. Users run `forge \u003ccommand\u003e` to interact with the system.\n\n**Command structure** (see plan lines 1090-1227):\n\n```\nforge\n├── --verbose (-v)     Enable debug logging\n├── config\n│   ├── show           Display current config (mask API key)\n│   └── set \u003ckey\u003e \u003cval\u003e  Set config value (server-url|api-key|hostname)\n├── sync               Sync to server\n│   ├── --force        Force sync even if recent\n│   ├── --retry        Only process pending queue\n│   └── --status       Show pending sync count\n├── tokens             Show daily token graph\n│   ├── --days (-d)    Number of days (default: 30)\n│   └── --local        Local data only, no server contact\n├── stats              Overall statistics (placeholder)\n├── models             Model breakdown (placeholder)\n└── machines           List machines (placeholder)\n```\n\n**Main flow for `forge tokens`**:\n1. If not --local: maybe_auto_sync()\n2. show_sync_status()\n3. If --local: get_local_daily_stats()\n4. Else: fetch_daily_stats(), fallback to local on failure\n5. render_daily_graph()\n\n**Config set key mapping**:\n- server-url -\u003e server_url\n- api-key -\u003e api_key\n- hostname -\u003e hostname\n\n**API key masking**: Show first 8 chars + \"...\" if longer\n\n**Success criteria**:\n1. `forge --help` shows all commands\n2. `forge config show` displays config with masked API key\n3. `forge config set server-url http://localhost:8420` persists\n4. `forge sync` calls maybe_auto_sync(force=False)\n5. `forge sync --force` calls do_sync() directly\n6. `forge sync --status` shows pending count\n7. `forge tokens` shows graph from server (with auto-sync)\n8. `forge tokens --local` shows local data without server\n9. `forge tokens --days 7` limits to 7 days\n","status":"closed","priority":2,"issue_type":"task","assignee":"epic:claudeforge-central","created_at":"2026-01-08T13:49:16.594516313-08:00","created_by":"kingcu","updated_at":"2026-01-08T16:05:35.803987695-08:00","closed_at":"2026-01-08T16:05:35.803987695-08:00","close_reason":"Implemented main.py and cli.py modules","dependencies":[{"issue_id":"claudeforge-0lk","depends_on_id":"claudeforge-68x","type":"parent-child","created_at":"2026-01-08T13:49:22.894500458-08:00","created_by":"kingcu"},{"issue_id":"claudeforge-0lk","depends_on_id":"claudeforge-sn8","type":"blocks","created_at":"2026-01-08T13:49:22.948406068-08:00","created_by":"kingcu"},{"issue_id":"claudeforge-0lk","depends_on_id":"claudeforge-jkf","type":"blocks","created_at":"2026-01-08T13:49:23.002360025-08:00","created_by":"kingcu"},{"issue_id":"claudeforge-0lk","depends_on_id":"claudeforge-akh","type":"blocks","created_at":"2026-01-08T13:49:23.055084359-08:00","created_by":"kingcu"},{"issue_id":"claudeforge-0lk","depends_on_id":"claudeforge-75h","type":"blocks","created_at":"2026-01-08T13:49:23.109177343-08:00","created_by":"kingcu"}]}
{"id":"claudeforge-1li","title":"Implement server Pydantic models (models.py)","description":"Create all Pydantic models for request/response validation in the sync API.\n\n**Context**: These models define the API contract between client and server. They enforce data validation, ensure type safety, and document the expected payload structure.\n\n**Source data structure** (from ~/.claude/stats-cache.json):\n- dailyActivity[]: {date, messageCount, sessionCount, toolCallCount} - per-day ONLY, NOT per-model\n- dailyModelTokens[]: {date, tokensByModel: {model: tokens}} - per-day per-model\n- modelUsage: {model: {inputTokens, outputTokens, cacheReadInputTokens, cacheCreationInputTokens}}\n\n**Constants**:\n- PROTOCOL_VERSION = 1 (for future compatibility)\n- MAX_SYNC_DAYS = 365 (reject data older than 1 year)\n\n**Request models** (see plan lines 279-327):\n- DailyActivityRecord: date (validated), message_count, session_count, tool_call_count (all ge=0)\n- DailyTokensRecord: date (validated), model (min_length=1), tokens (ge=0)\n- ModelUsageRecord: model, input_tokens, output_tokens, cache_read_tokens, cache_creation_tokens\n- SyncRequest: protocol_version (ge=1, le=PROTOCOL_VERSION), hostname (min_length=1, max_length=255), arrays of above\n\n**Response models** (see plan lines 329-383):\n- SyncResponse: status, protocol_version, records_upserted, machine_registered, server_time\n- DailyStatsRecord: date, total_tokens, message_count, session_count, tool_call_count, machines[]\n- DailyStatsResponse: days[]\n- MachineRecord: hostname, first_seen, last_sync, is_active\n- MachinesResponse: machines[]\n- ModelStatsRecord: model, total_tokens, input_tokens, output_tokens, cache_read_tokens\n- ModelsResponse: models[]\n- TotalsResponse: total_tokens, total_messages, total_sessions, machine_count, first_activity, last_activity\n- HealthResponse: status, database, schema_version\n- ErrorResponse: detail\n\n**Date validation logic** (field_validator):\n1. Parse with datetime.strptime(v, '%Y-%m-%d')\n2. Reject if (datetime.now() - parsed).days \u003e MAX_SYNC_DAYS\n3. Reject if parsed.date() \u003e datetime.now().date() (no future dates)\n4. Return validated string\n\n**Pitfalls**:\n- DailyActivityRecord is NOT per-model (common mistake from looking at dailyModelTokens)\n- Field() defaults must use default_factory=list for mutable defaults\n- field_validator needs @classmethod decorator in Pydantic v2\n\n**Success criteria**:\n1. All models importable: `from forgeserver.models import SyncRequest, SyncResponse, ...`\n2. Valid SyncRequest parses without error\n3. SyncRequest with date \u003e 365 days ago raises ValidationError\n4. SyncRequest with future date raises ValidationError\n5. SyncRequest with negative token count raises ValidationError\n6. SyncRequest with protocol_version \u003e PROTOCOL_VERSION raises ValidationError\n","status":"closed","priority":2,"issue_type":"task","assignee":"epic:claudeforge-central","created_at":"2026-01-08T13:44:56.254936857-08:00","created_by":"kingcu","updated_at":"2026-01-08T16:02:33.211708792-08:00","closed_at":"2026-01-08T16:02:33.211708792-08:00","close_reason":"Implemented all modules as per plan","dependencies":[{"issue_id":"claudeforge-1li","depends_on_id":"claudeforge-68x","type":"parent-child","created_at":"2026-01-08T13:45:02.856239948-08:00","created_by":"kingcu"},{"issue_id":"claudeforge-1li","depends_on_id":"claudeforge-sn8","type":"blocks","created_at":"2026-01-08T13:45:02.908356147-08:00","created_by":"kingcu"},{"issue_id":"claudeforge-1li","depends_on_id":"claudeforge-b6n","type":"blocks","created_at":"2026-01-08T13:45:02.959426935-08:00","created_by":"kingcu"}]}
{"id":"claudeforge-4z6","title":"Create client/ directory structure with pyproject.toml","description":"Create the client/ directory structure for the CLI application.\n\n**Context**: The client is a Python CLI that reads local Claude Code stats and syncs them to the central server.\n\n**Directory structure**:\n```\nclient/\n├── pyproject.toml\n├── src/\n│   └── forgeclient/\n│       └── __init__.py\n└── tests/\n    └── __init__.py\n```\n\n**pyproject.toml specifications**:\n- name: forgeclient\n- version: 0.1.0\n- requires-python: \u003e=3.12\n- dependencies: click\u003e=8.1.0, httpx\u003e=0.28.0, rich\u003e=13.9.0\n- [project.scripts] forge = \"forgeclient.cli:cli\"\n- dev dependencies: pytest\u003e=8.0.0\n- build-system: hatchling\n- [tool.hatch.build.targets.wheel] packages = [\"src/forgeclient\"]\n\n**__init__.py content**:\n```python\n\"\"\"Forge Client - CLI for Claude Code usage tracking.\"\"\"\n__version__ = \"0.1.0\"\n```\n\n**Success criteria**:\n1. All directories and files exist as specified\n2. `pip install -e ./client` succeeds\n3. `forge --help` shows usage (after cli.py is implemented)\n4. `python -c \"from forgeclient import __version__; print(__version__)\"` outputs \"0.1.0\"\n","status":"closed","priority":2,"issue_type":"task","assignee":"epic:claudeforge-central","created_at":"2026-01-08T13:47:34.910264692-08:00","created_by":"kingcu","updated_at":"2026-01-08T16:01:16.249972582-08:00","closed_at":"2026-01-08T16:01:16.249972582-08:00","close_reason":"Created directory structures with pyproject.toml and __init__.py files","dependencies":[{"issue_id":"claudeforge-4z6","depends_on_id":"claudeforge-68x","type":"parent-child","created_at":"2026-01-08T13:47:40.412437741-08:00","created_by":"kingcu"},{"issue_id":"claudeforge-4z6","depends_on_id":"claudeforge-sn8","type":"blocks","created_at":"2026-01-08T13:47:40.465377041-08:00","created_by":"kingcu"},{"issue_id":"claudeforge-4z6","depends_on_id":"claudeforge-qhw","type":"blocks","created_at":"2026-01-08T15:19:15.44650059-08:00","created_by":"kingcu"}]}
{"id":"claudeforge-5qo","title":"Create docker-compose.yml and .env.example","description":"Create Docker Compose configuration for easy deployment.\n\n**Context**: Single command to start the server with persistent storage and automatic backups.\n\n**Files to create**:\n\n1. docker-compose.yml (see plan lines 1672-1713):\n   - forgeserver service: builds ./server, exposes port, mounts volume\n   - backup service: daily SQLite backups, 7-day retention\n   - Named volume: forge-data\n\n2. .env.example (see plan lines 1716-1727):\n   - FORGE_API_KEY=your-secret-api-key-here\n   - FORGE_PORT=8420\n   - Instructions: \"openssl rand -hex 32\"\n\n**docker-compose.yml details**:\n```yaml\nservices:\n  forgeserver:\n    build: ./server\n    ports:\n      - \"${FORGE_PORT:-8420}:8000\"\n    volumes:\n      - forge-data:/data\n    environment:\n      - DATABASE_PATH=/data/usage.db\n      - FORGE_API_KEY=${FORGE_API_KEY}\n    healthcheck:\n      test: [\"CMD\", \"curl\", \"-f\", \"http://localhost:8000/health\"]\n      interval: 30s\n      timeout: 10s\n      retries: 3\n    restart: unless-stopped\n\n  backup:\n    image: alpine\n    # Daily backup script with 7-day retention\n    ...\n\nvolumes:\n  forge-data:\n```\n\n**Success criteria**:\n1. `cp .env.example .env \u0026\u0026 vim .env` workflow documented\n2. `docker compose up -d` starts server\n3. `curl localhost:8420/health` returns healthy\n4. Data persists after `docker compose down \u0026\u0026 docker compose up`\n5. Backup container creates files in ./backups/\n","status":"closed","priority":2,"issue_type":"task","assignee":"epic:claudeforge-central","created_at":"2026-01-08T13:49:51.396643529-08:00","created_by":"kingcu","updated_at":"2026-01-08T16:07:10.618774547-08:00","closed_at":"2026-01-08T16:07:10.618774547-08:00","close_reason":"Created docker-compose.yml with backup service and .env.example","dependencies":[{"issue_id":"claudeforge-5qo","depends_on_id":"claudeforge-68x","type":"parent-child","created_at":"2026-01-08T13:49:57.079865873-08:00","created_by":"kingcu"},{"issue_id":"claudeforge-5qo","depends_on_id":"claudeforge-sn8","type":"blocks","created_at":"2026-01-08T13:49:57.13372483-08:00","created_by":"kingcu"},{"issue_id":"claudeforge-5qo","depends_on_id":"claudeforge-0aa","type":"blocks","created_at":"2026-01-08T13:49:57.18792747-08:00","created_by":"kingcu"}]}
{"id":"claudeforge-68x","title":"EPIC: claudeforge-central","description":"Top-level epic for centralized Claude Code usage tracking service.\n\n**Problem**: Claude Max users want to track token usage across multiple machines but Claude Code's stats-cache.json is local-only. The Anthropic Admin API requires an organization plan.\n\n**Solution**: Client-server architecture where multiple computers sync their local Claude Code usage to a central FastAPI+SQLite service via REST API.\n\n**Architecture**:\n- Server: FastAPI + SQLite, containerized, API key auth\n- Client: Python CLI (forge) that reads ~/.claude/stats-cache.json and syncs to server\n- Network: Tailscale/VPN/LAN for private access\n\n**Key Data Model Insight**:\n- dailyActivity is per-day only (NOT per-model): messageCount, sessionCount, toolCallCount\n- dailyModelTokens is per-day per-model: tokensByModel map\n- modelUsage is cumulative per-model: input/output/cache tokens\n\n**Sync Behavior**:\n- Idempotent: repeated syncs with same data produce same result\n- Lazy auto-sync: when running commands, sync if \u003e1hr stale\n- Offline resilience: queue syncs for retry when server unreachable\n\n**Plan file**: /home/kingcu/.claude/plans/groovy-puzzling-forest.md (refinement round 5)\n\n**Success criteria**:\n- Server deploys via docker-compose\n- Client installs via pip, provides 'forge' command\n- forge sync sends data to server\n- forge tokens displays aggregated graph from all machines\n- forge tokens --local shows local data only\n","status":"closed","priority":2,"issue_type":"epic","assignee":"epic:claudeforge-central","created_at":"2026-01-08T13:44:17.350972193-08:00","created_by":"kingcu","updated_at":"2026-01-08T16:13:30.568118749-08:00","closed_at":"2026-01-08T16:13:30.568118749-08:00","close_reason":"Epic complete: All 21 beads closed. Server (FastAPI+SQLite) and client (Click CLI) implemented with full test coverage."}
{"id":"claudeforge-75h","title":"Implement Claude Code stats parser (claude_code.py)","description":"Create module to parse Claude Code's stats-cache.json and build sync payloads.\n\n**Context**: Claude Code stores usage statistics at ~/.claude/stats-cache.json. This module reads that file and transforms it into the format expected by the server API.\n\n**Source file**: ~/.claude/stats-cache.json\n\n**Source data structure** (see plan lines 51-71):\n```json\n{\n  \"dailyActivity\": [\n    {\"date\": \"2026-01-07\", \"messageCount\": 85, \"sessionCount\": 1, \"toolCallCount\": 21}\n  ],\n  \"dailyModelTokens\": [\n    {\"date\": \"2026-01-07\", \"tokensByModel\": {\"claude-opus-4-5-20251101\": 7838}}\n  ],\n  \"modelUsage\": {\n    \"claude-opus-4-5-20251101\": {\n      \"inputTokens\": 64678,\n      \"outputTokens\": 166952,\n      \"cacheReadInputTokens\": 116344779,\n      \"cacheCreationInputTokens\": 10714387\n    }\n  }\n}\n```\n\n**CRITICAL INSIGHT**: dailyActivity is per-day ONLY (not per-model). dailyModelTokens IS per-day per-model.\n\n**Functions** (see plan lines 587-713):\n\n1. load_stats_cache() -\u003e Optional[dict]:\n   - Read and parse ~/.claude/stats-cache.json\n   - Return None if missing or corrupt\n\n2. get_hostname() -\u003e str:\n   - Check config for custom hostname\n   - Fall back to socket.gethostname()\n\n3. build_sync_payload(days: int = 365) -\u003e dict:\n   - Transform source to SyncRequest format\n   - Filter by date cutoff\n   - Map field names (camelCase -\u003e snake_case)\n   - Flatten dailyModelTokens (one entry per model per day)\n\n4. get_local_daily_stats(days: int = 30) -\u003e list[dict]:\n   - For --local mode display\n   - Combine activity + tokens by date\n   - Return format matching DailyStatsRecord\n\n**Field mapping**:\n- messageCount -\u003e message_count\n- sessionCount -\u003e session_count\n- toolCallCount -\u003e tool_call_count\n- inputTokens -\u003e input_tokens\n- outputTokens -\u003e output_tokens\n- cacheReadInputTokens -\u003e cache_read_tokens\n- cacheCreationInputTokens -\u003e cache_creation_tokens\n\n**Success criteria**:\n1. Missing stats file returns empty payload (not crash)\n2. Date filtering excludes old entries\n3. dailyModelTokens correctly flattened to list of {date, model, tokens}\n4. modelUsage correctly transformed with field name mapping\n5. get_local_daily_stats() returns data compatible with display.py\n","status":"closed","priority":2,"issue_type":"task","assignee":"epic:claudeforge-central","created_at":"2026-01-08T13:48:09.411039489-08:00","created_by":"kingcu","updated_at":"2026-01-08T16:03:52.399548258-08:00","closed_at":"2026-01-08T16:03:52.399548258-08:00","close_reason":"Implemented db.py and claude_code.py modules","dependencies":[{"issue_id":"claudeforge-75h","depends_on_id":"claudeforge-68x","type":"parent-child","created_at":"2026-01-08T13:48:14.755117613-08:00","created_by":"kingcu"},{"issue_id":"claudeforge-75h","depends_on_id":"claudeforge-sn8","type":"blocks","created_at":"2026-01-08T13:48:14.808382669-08:00","created_by":"kingcu"},{"issue_id":"claudeforge-75h","depends_on_id":"claudeforge-gkf","type":"blocks","created_at":"2026-01-08T13:48:14.86263091-08:00","created_by":"kingcu"}]}
{"id":"claudeforge-77w","title":"Write pytest tests for client","description":"Create test suite for client components.\n\n**Context**: Tests verify config handling, stats parsing, and sync behavior without hitting real servers.\n\n**Test files** (see plan lines 1868-1902):\n\n1. client/tests/conftest.py:\n   - temp_config_dir fixture: monkeypatch CONFIG_DIR/CONFIG_PATH to tmp_path\n\n2. client/tests/test_claude_code.py:\n   - test_build_sync_payload_empty: missing file returns empty payload\n   - test_build_sync_payload_with_data: correctly transforms source\n\n3. client/tests/test_sync.py:\n   - test_sync_skips_when_unconfigured: no server_url returns \"skipped\"\n   - test_config_defaults: missing file returns defaults\n   - test_config_persistence: save + load roundtrip\n\n**Key testing patterns**:\n- Use monkeypatch to isolate from real ~/.claudeforge/\n- Use tmp_path for temp config/cache directories\n- Mock httpx requests for sync tests (or use responses library)\n\n**Success criteria**:\n1. `cd client \u0026\u0026 pip install -e \".[dev]\" \u0026\u0026 pytest -v` passes\n2. Tests don't read/write real ~/.claude/ or ~/.claudeforge/\n3. Tests isolated via monkeypatch\n4. No network calls in unit tests\n","status":"closed","priority":2,"issue_type":"task","assignee":"epic:claudeforge-central","created_at":"2026-01-08T13:49:33.994894944-08:00","created_by":"kingcu","updated_at":"2026-01-08T16:06:35.933081664-08:00","closed_at":"2026-01-08T16:06:35.933081664-08:00","close_reason":"Created Dockerfile and comprehensive test suites","dependencies":[{"issue_id":"claudeforge-77w","depends_on_id":"claudeforge-68x","type":"parent-child","created_at":"2026-01-08T13:49:40.708838453-08:00","created_by":"kingcu"},{"issue_id":"claudeforge-77w","depends_on_id":"claudeforge-sn8","type":"blocks","created_at":"2026-01-08T13:49:40.763957776-08:00","created_by":"kingcu"},{"issue_id":"claudeforge-77w","depends_on_id":"claudeforge-0lk","type":"blocks","created_at":"2026-01-08T13:49:40.818987583-08:00","created_by":"kingcu"}]}
{"id":"claudeforge-87z","title":"Implement offline sync queue (local_cache.py)","description":"Create local cache for offline operation and pending sync queue.\n\n**Context**: When the server is unreachable, syncs are queued for later retry. Also caches last server response for offline display.\n\n**File paths**:\n- CACHE_DIR = ~/.claudeforge/cache/\n- PENDING_SYNCS = cache/pending_syncs.json\n- LAST_SERVER_DATA = cache/last_server_data.json\n- MAX_PENDING_SYNCS = 100\n\n**Functions** (see plan lines 764-854):\n\n1. queue_sync(payload: dict) -\u003e bool:\n   - Append to pending_syncs.json\n   - If len \u003e MAX_PENDING_SYNCS, drop oldest (FIFO)\n   - Include queued_at timestamp\n\n2. get_pending_count() -\u003e int\n\n3. list_pending() -\u003e list[dict]:\n   - Each item: {payload, queued_at}\n\n4. clear_pending() -\u003e None\n\n5. process_pending_syncs(server_url, api_key, timeout=30.0) -\u003e tuple[int, int]:\n   - Try each pending sync in order\n   - Remove successful, keep failed\n   - Returns (success_count, fail_count)\n\n6. save_server_data(data: dict) -\u003e None:\n   - Cache with cached_at timestamp\n\n7. load_server_data() -\u003e Optional[dict]:\n   - Return cached data or None\n\n**Queue item format**:\n```json\n{\n  \"payload\": {\u003cSyncRequest data\u003e},\n  \"queued_at\": \"2026-01-08T12:00:00\"\n}\n```\n\n**Success criteria**:\n1. Queue persists across process restarts\n2. FIFO ordering maintained\n3. Oldest dropped when exceeding MAX_PENDING_SYNCS\n4. process_pending_syncs removes only successful items\n5. Cached server data loadable for offline display\n6. Corrupt cache files don't crash - return empty/None\n","status":"closed","priority":2,"issue_type":"task","assignee":"epic:claudeforge-central","created_at":"2026-01-08T13:48:25.47680481-08:00","created_by":"kingcu","updated_at":"2026-01-08T16:02:33.217229771-08:00","closed_at":"2026-01-08T16:02:33.217229771-08:00","close_reason":"Implemented all modules as per plan","dependencies":[{"issue_id":"claudeforge-87z","depends_on_id":"claudeforge-68x","type":"parent-child","created_at":"2026-01-08T13:48:31.054198696-08:00","created_by":"kingcu"},{"issue_id":"claudeforge-87z","depends_on_id":"claudeforge-sn8","type":"blocks","created_at":"2026-01-08T13:48:31.107266544-08:00","created_by":"kingcu"},{"issue_id":"claudeforge-87z","depends_on_id":"claudeforge-4z6","type":"blocks","created_at":"2026-01-08T13:48:31.162133651-08:00","created_by":"kingcu"}]}
{"id":"claudeforge-akh","title":"Implement Rich terminal display (display.py)","description":"Create terminal display module using Rich for pretty output.\n\n**Context**: Renders usage graphs and status messages with colors and unicode characters.\n\n**Constants**:\n- BAR_CHARS = \" ▁▂▃▄▅▆▇█\" (9 chars for varying heights)\n- GRAPH_HEIGHT = 12 (rows in vertical bar chart)\n\n**Functions** (see plan lines 982-1087):\n\n1. format_number(n: int) -\u003e str:\n   - 1500 -\u003e \"1.5K\"\n   - 1500000 -\u003e \"1.5M\"\n   - 999 -\u003e \"999\"\n\n2. render_daily_graph(data: list[dict], title: str):\n   - Vertical bar chart with Y-axis labels\n   - Y-axis: max value, midpoint, 0\n   - Bars: green unicode blocks\n   - X-axis: first date, last date\n   - Summary: total tokens, messages, avg/day\n   - Rich markup for colors: [bold cyan], [green], [dim]\n\n3. show_sync_status(result: SyncResult, pending_count: int = 0):\n   - success: [green]✓ Synced N records[/green]\n   - queued: [yellow]⚠ message (queued for retry)[/yellow]\n   - skipped: [dim]↷ message[/dim]\n   - error: [red]✗ message[/red]\n   - Append pending count if \u003e 0\n\n4. show_stale_warning(config: dict):\n   - If last_sync_success=False, warn user\n   - Show last_error if available\n\n**Graph layout**:\n```\n  Daily Usage (last 30 days)\n  ──────────────────────────────────────────────────\n  1.5M │████████████████████████████████\n   750K │████████████████████████████████████████████\n     0 │████████████████████████████████████████████████\n       └────────────────────────────────────────────────\n        01-01                                     01-30\n\n  ──────────────────────────────────────────────────\n  Total: 45.2M tokens, 1,234 messages\n  Average: 1.5M/day\n```\n\n**Success criteria**:\n1. Empty data shows \"No usage data available\" (yellow)\n2. Graph renders correctly with sample data\n3. Numbers use K/M suffixes appropriately\n4. Rich colors render in terminal\n5. Sync status shows appropriate icon and color\n","status":"closed","priority":2,"issue_type":"task","assignee":"epic:claudeforge-central","created_at":"2026-01-08T13:49:00.247241599-08:00","created_by":"kingcu","updated_at":"2026-01-08T16:02:33.218155026-08:00","closed_at":"2026-01-08T16:02:33.218155026-08:00","close_reason":"Implemented all modules as per plan","dependencies":[{"issue_id":"claudeforge-akh","depends_on_id":"claudeforge-68x","type":"parent-child","created_at":"2026-01-08T13:49:05.292093522-08:00","created_by":"kingcu"},{"issue_id":"claudeforge-akh","depends_on_id":"claudeforge-sn8","type":"blocks","created_at":"2026-01-08T13:49:05.345237368-08:00","created_by":"kingcu"},{"issue_id":"claudeforge-akh","depends_on_id":"claudeforge-4z6","type":"blocks","created_at":"2026-01-08T13:49:05.398334437-08:00","created_by":"kingcu"}]}
{"id":"claudeforge-b6n","title":"Create server/ directory structure with pyproject.toml","description":"Create the server/ directory structure for the FastAPI application.\n\n**Context**: This is the foundation for the server component of claudeforge-central. The server receives usage data from multiple client machines and aggregates it for querying.\n\n**Directory structure to create**:\n```\nserver/\n├── pyproject.toml\n├── src/\n│   └── forgeserver/\n│       ├── __init__.py\n│       └── routers/\n│           └── __init__.py\n└── tests/\n    └── __init__.py\n```\n\n**pyproject.toml specifications**:\n- name: forgeserver\n- version: 0.1.0\n- requires-python: \u003e=3.12\n- dependencies: fastapi\u003e=0.115.0, uvicorn[standard]\u003e=0.32.0, pydantic\u003e=2.10.0\n- dev dependencies: pytest\u003e=8.0.0, pytest-asyncio\u003e=0.24.0, httpx\u003e=0.28.0\n- build-system: hatchling\n- [tool.hatch.build.targets.wheel] packages = [\"src/forgeserver\"]\n\n**__init__.py content**:\n```python\n\"\"\"Forge Server - Central usage tracking service.\"\"\"\n__version__ = \"0.1.0\"\n```\n\n**Pitfalls to avoid**:\n- Forgetting routers/__init__.py (needed for package import)\n- Wrong hatch build config (packages must point to src/forgeserver)\n\n**Success criteria**:\n1. All directories and files exist as specified\n2. `pip install -e ./server` succeeds without errors\n3. `python -c \"from forgeserver import __version__; print(__version__)\"` outputs \"0.1.0\"\n4. `python -c \"from forgeserver.routers import *\"` succeeds (empty but valid package)\n","status":"closed","priority":2,"issue_type":"task","assignee":"epic:claudeforge-central","created_at":"2026-01-08T13:44:38.654840767-08:00","created_by":"kingcu","updated_at":"2026-01-08T16:01:16.246365232-08:00","closed_at":"2026-01-08T16:01:16.246365232-08:00","close_reason":"Created directory structures with pyproject.toml and __init__.py files","dependencies":[{"issue_id":"claudeforge-b6n","depends_on_id":"claudeforge-68x","type":"parent-child","created_at":"2026-01-08T13:44:44.466348764-08:00","created_by":"kingcu"},{"issue_id":"claudeforge-b6n","depends_on_id":"claudeforge-sn8","type":"blocks","created_at":"2026-01-08T13:44:44.51597167-08:00","created_by":"kingcu"},{"issue_id":"claudeforge-b6n","depends_on_id":"claudeforge-qhw","type":"blocks","created_at":"2026-01-08T15:19:15.393436035-08:00","created_by":"kingcu"}]}
{"id":"claudeforge-dgp","title":"Implement server SQLite database module (db.py)","description":"Create database module with schema initialization and all query functions.\n\n**Context**: SQLite database stores all usage data. The schema supports multi-machine aggregation with soft-delete capability for machines.\n\n**Schema** (see plan lines 452-510 for full DDL):\n- schema_version: tracks DB migrations\n- machines: hostname (UNIQUE), first_seen, last_sync, is_active (1=active, 0=soft-deleted)\n- daily_activity: hostname, date, message_count, session_count, tool_call_count - UNIQUE(hostname, date)\n- daily_tokens: hostname, date, model, tokens - UNIQUE(hostname, date, model)\n- model_usage: hostname, model, input/output/cache tokens - UNIQUE(hostname, model)\n\n**Foreign key relationships**:\n- All tables reference machines(hostname) with ON DELETE CASCADE\n- PRAGMA foreign_keys = ON required on every connection\n\n**Functions to implement**:\n\n1. init_db(): Create all tables and indexes, insert schema_version=1\n\n2. get_db(): Context manager yielding connection\n   - Enable FK with PRAGMA foreign_keys = ON\n   - Set row_factory = sqlite3.Row\n   - Auto-commit on success, rollback on exception\n\n3. sync_usage(request: SyncRequest) -\u003e tuple[int, bool]:\n   - Returns (records_upserted, machine_was_registered)\n   - Single transaction for all upserts\n   - Use INSERT...ON CONFLICT DO UPDATE for idempotency\n   - Reactivate soft-deleted machines on sync\n\n4. get_daily_stats(days: int = 30) -\u003e list[DailyStatsRecord]:\n   - Aggregate tokens by date (SUM across machines)\n   - Aggregate activity by date (SUM across machines) - separate query since not per-model\n   - JOIN machines WHERE is_active = 1\n   - ORDER BY date ASC\n\n5. get_machines() -\u003e list[dict]: All machines with status\n\n6. get_model_stats(days: int = 30) -\u003e list[dict]: Aggregate by model\n\n7. get_totals() -\u003e dict: All-time totals\n\n8. delete_machine(hostname, hard=False) -\u003e bool:\n   - hard=False: UPDATE is_active=0\n   - hard=True: DELETE (CASCADE removes child records)\n\n9. reactivate_machine(hostname) -\u003e bool: UPDATE is_active=1\n\n10. get_machine_stats(hostname, days) -\u003e list[DailyStatsRecord]: Single machine\n\n**Key insight for get_daily_stats**:\nThe daily_activity table is NOT per-model, while daily_tokens IS. Cannot join directly - must:\n1. Query tokens grouped by date\n2. Query activity grouped by date (separate)\n3. Merge via Python dict lookup\n\n**Pitfalls**:\n- Forgetting PRAGMA foreign_keys = ON (FK constraints ignored silently)\n- Using INSERT OR REPLACE instead of INSERT...ON CONFLICT (deletes then inserts, loses auto-increment IDs)\n- Not filtering by is_active = 1 in aggregation queries\n\n**Success criteria**:\n1. init_db() creates all tables without error\n2. sync_usage() is idempotent: same payload twice = same record count\n3. Soft delete excludes machine from get_daily_stats()\n4. Hard delete removes machine and all child records (verify with COUNT)\n5. get_daily_stats() correctly sums across multiple machines\n6. Reactivate restores machine to stats\n","status":"closed","priority":2,"issue_type":"task","assignee":"epic:claudeforge-central","created_at":"2026-01-08T13:45:17.618744578-08:00","created_by":"kingcu","updated_at":"2026-01-08T16:03:52.396187583-08:00","closed_at":"2026-01-08T16:03:52.396187583-08:00","close_reason":"Implemented db.py and claude_code.py modules","dependencies":[{"issue_id":"claudeforge-dgp","depends_on_id":"claudeforge-68x","type":"parent-child","created_at":"2026-01-08T13:45:23.090660225-08:00","created_by":"kingcu"},{"issue_id":"claudeforge-dgp","depends_on_id":"claudeforge-sn8","type":"blocks","created_at":"2026-01-08T13:45:23.142934497-08:00","created_by":"kingcu"},{"issue_id":"claudeforge-dgp","depends_on_id":"claudeforge-1li","type":"blocks","created_at":"2026-01-08T13:45:23.19404938-08:00","created_by":"kingcu"}]}
{"id":"claudeforge-ds2","title":"Implement POST /v1/sync endpoint (routers/sync.py)","description":"Create sync router with POST /v1/sync endpoint for receiving usage data.\n\n**Context**: This is the primary data ingestion endpoint. Clients call this to upload their local Claude Code stats.\n\n**Endpoint**: POST /v1/sync\n- Request: SyncRequest model (validated by Pydantic)\n- Response: SyncResponse model\n- Auth: Required (X-API-Key header via verify_api_key dependency)\n\n**Implementation** (see plan lines 1384-1408):\n```python\nfrom datetime import datetime\nfrom fastapi import APIRouter\nfrom ..db import sync_usage\nfrom ..models import SyncRequest, SyncResponse, PROTOCOL_VERSION\n\nrouter = APIRouter(tags=[\"sync\"])\n\n@router.post(\"/sync\", response_model=SyncResponse)\nasync def sync(request: SyncRequest):\n    count, registered = sync_usage(request)\n    return SyncResponse(\n        status=\"success\",\n        protocol_version=PROTOCOL_VERSION,\n        records_upserted=count,\n        machine_registered=registered,\n        server_time=datetime.now().isoformat()\n    )\n```\n\n**Behavior**:\n- Calls sync_usage() which performs idempotent upserts\n- machine_registered=True only on first sync from a hostname\n- records_upserted counts all records (activity + tokens + model_usage)\n- server_time helps clients verify clock sync\n\n**Success criteria**:\n1. POST /v1/sync with valid JSON returns 200 + SyncResponse\n2. POST /v1/sync with invalid JSON returns 422\n3. POST /v1/sync without auth returns 401/422\n4. First sync from new hostname: machine_registered=True\n5. Subsequent syncs: machine_registered=False\n6. Same data synced twice: same records_upserted count\n","status":"closed","priority":2,"issue_type":"task","assignee":"epic:claudeforge-central","created_at":"2026-01-08T13:45:51.036374963-08:00","created_by":"kingcu","updated_at":"2026-01-08T16:04:44.778413241-08:00","closed_at":"2026-01-08T16:04:44.778413241-08:00","close_reason":"Implemented all router and sync modules","dependencies":[{"issue_id":"claudeforge-ds2","depends_on_id":"claudeforge-68x","type":"parent-child","created_at":"2026-01-08T13:45:58.018461508-08:00","created_by":"kingcu"},{"issue_id":"claudeforge-ds2","depends_on_id":"claudeforge-sn8","type":"blocks","created_at":"2026-01-08T13:45:58.070313066-08:00","created_by":"kingcu"},{"issue_id":"claudeforge-ds2","depends_on_id":"claudeforge-dgp","type":"blocks","created_at":"2026-01-08T13:45:58.12272152-08:00","created_by":"kingcu"},{"issue_id":"claudeforge-ds2","depends_on_id":"claudeforge-1li","type":"blocks","created_at":"2026-01-08T13:45:58.174778927-08:00","created_by":"kingcu"}]}
{"id":"claudeforge-e7r","title":"Implement GET /v1/stats/* endpoints (routers/stats.py)","description":"Create stats router with all query endpoints for retrieving aggregated data.\n\n**Context**: These endpoints allow clients to fetch usage statistics aggregated across all machines.\n\n**Endpoints** (see plan lines 1411-1479):\n\n1. GET /v1/stats/daily?days=30 -\u003e DailyStatsResponse\n   - Aggregates tokens and activity by date\n   - Only includes active machines\n   - days parameter: Query(default=30, ge=1, le=365)\n\n2. GET /v1/stats/machines -\u003e MachinesResponse\n   - Lists all machines (including inactive)\n   - Shows first_seen, last_sync, is_active\n\n3. GET /v1/stats/models?days=30 -\u003e ModelsResponse\n   - Aggregates by model across all active machines\n   - Shows input/output/cache token breakdown\n\n4. GET /v1/stats/totals -\u003e TotalsResponse\n   - All-time totals: tokens, messages, sessions\n   - Machine count, first/last activity dates\n\n5. GET /v1/stats/machine/{hostname}?days=30 -\u003e DailyStatsResponse\n   - Same as daily but filtered to single machine\n   - Useful for per-machine drill-down\n\n**Implementation pattern**:\n```python\nrouter = APIRouter(prefix=\"/stats\", tags=[\"stats\"])\n\n@router.get(\"/daily\", response_model=DailyStatsResponse)\nasync def daily_stats(days: int = Query(default=30, ge=1, le=365)):\n    data = get_daily_stats(days)\n    return DailyStatsResponse(days=data)\n```\n\n**Success criteria**:\n1. All 5 endpoints return 200 with correct response model\n2. days=0 returns 422 (validation error)\n3. days=366 returns 422\n4. Empty database returns empty arrays (not errors)\n5. Soft-deleted machines excluded from /daily, /models, /totals\n6. Soft-deleted machines visible in /machines with is_active=False\n7. /machine/{hostname} returns data for that hostname only\n","status":"closed","priority":2,"issue_type":"task","assignee":"epic:claudeforge-central","created_at":"2026-01-08T13:46:09.112975019-08:00","created_by":"kingcu","updated_at":"2026-01-08T16:04:44.781993754-08:00","closed_at":"2026-01-08T16:04:44.781993754-08:00","close_reason":"Implemented all router and sync modules","dependencies":[{"issue_id":"claudeforge-e7r","depends_on_id":"claudeforge-68x","type":"parent-child","created_at":"2026-01-08T13:46:15.229181225-08:00","created_by":"kingcu"},{"issue_id":"claudeforge-e7r","depends_on_id":"claudeforge-sn8","type":"blocks","created_at":"2026-01-08T13:46:15.281001222-08:00","created_by":"kingcu"},{"issue_id":"claudeforge-e7r","depends_on_id":"claudeforge-dgp","type":"blocks","created_at":"2026-01-08T13:46:15.330704038-08:00","created_by":"kingcu"},{"issue_id":"claudeforge-e7r","depends_on_id":"claudeforge-1li","type":"blocks","created_at":"2026-01-08T13:46:15.382765912-08:00","created_by":"kingcu"}]}
{"id":"claudeforge-fqu","title":"Write pytest tests for server","description":"Create test suite for server components.\n\n**Context**: Tests verify sync idempotency, stats aggregation, auth, and endpoint behavior.\n\n**Test files** (see plan lines 1730-1866):\n\n1. server/tests/conftest.py:\n   - temp_db fixture: creates temp file, sets DATABASE_PATH env\n   - api_key fixture: sets FORGE_API_KEY=\"test-key-12345\"\n   - client fixture: TestClient(app)\n\n2. server/tests/test_sync.py:\n   - test_sync_creates_machine: first sync sets machine_registered=True\n   - test_sync_idempotent: second sync sets machine_registered=False\n   - test_sync_requires_auth: missing key returns 401/422\n\n3. server/tests/test_stats.py:\n   - test_daily_stats_empty: returns empty array\n   - test_daily_stats_with_data: synced data appears\n   - test_machines_list: machines visible after sync\n   - test_machine_soft_delete: soft delete excludes from stats\n   - test_machine_reactivate: restores to stats\n\n**Key testing patterns**:\n- Each test gets fresh temp database\n- Use TestClient for synchronous HTTP testing\n- Assert both status codes and response bodies\n\n**Success criteria**:\n1. `cd server \u0026\u0026 pip install -e \".[dev]\" \u0026\u0026 pytest -v` passes\n2. All tests isolated (temp DB per test)\n3. Coverage of happy path + error cases\n4. No warnings about async fixtures\n","status":"closed","priority":2,"issue_type":"task","assignee":"epic:claudeforge-central","created_at":"2026-01-08T13:47:19.263911189-08:00","created_by":"kingcu","updated_at":"2026-01-08T16:06:35.932231666-08:00","closed_at":"2026-01-08T16:06:35.932231666-08:00","close_reason":"Created Dockerfile and comprehensive test suites","dependencies":[{"issue_id":"claudeforge-fqu","depends_on_id":"claudeforge-68x","type":"parent-child","created_at":"2026-01-08T13:47:25.238181448-08:00","created_by":"kingcu"},{"issue_id":"claudeforge-fqu","depends_on_id":"claudeforge-sn8","type":"blocks","created_at":"2026-01-08T13:47:25.291356055-08:00","created_by":"kingcu"},{"issue_id":"claudeforge-fqu","depends_on_id":"claudeforge-mcz","type":"blocks","created_at":"2026-01-08T13:47:25.344535772-08:00","created_by":"kingcu"}]}
{"id":"claudeforge-gkf","title":"Implement client config management (config.py)","description":"Create configuration management module for the forge client.\n\n**Context**: Client configuration persists in ~/.claudeforge/config.json. Stores server URL, API key, and sync state.\n\n**File paths**:\n- CONFIG_DIR = Path.home() / \".claudeforge\"\n- CONFIG_PATH = CONFIG_DIR / \"config.json\"\n\n**Config schema** (see plan lines 186-194):\n```json\n{\n  \"server_url\": \"http://forge-server:8000\",\n  \"api_key\": \"your-secret-key-here\",\n  \"hostname\": null,\n  \"last_sync\": \"2026-01-08T11:30:00Z\",\n  \"last_sync_success\": true,\n  \"last_error\": null\n}\n```\n\n**Functions** (see plan lines 717-761):\n\n1. load_config() -\u003e dict:\n   - Return DEFAULT_CONFIG.copy() merged with stored config\n   - Handle missing file, corrupt JSON gracefully (return defaults)\n\n2. save_config(config: dict) -\u003e None:\n   - Create CONFIG_DIR if not exists\n   - Write JSON with indent=2\n\n3. get_config_value(key: str) -\u003e Optional[str]:\n   - Convenience wrapper for load_config().get(key)\n\n4. set_config_value(key: str, value: str) -\u003e None:\n   - Load, update, save\n\n**DEFAULT_CONFIG**:\n```python\n{\n    \"server_url\": None,\n    \"api_key\": None,\n    \"hostname\": None,  # None = use socket.gethostname()\n    \"last_sync\": None,\n    \"last_sync_success\": True,\n    \"last_error\": None\n}\n```\n\n**Success criteria**:\n1. load_config() returns defaults when no config file exists\n2. save_config() creates ~/.claudeforge/ directory if needed\n3. Corrupt JSON file doesn't crash - returns defaults\n4. set_config_value() persists across process restarts\n5. Config file is human-readable (pretty-printed JSON)\n","status":"closed","priority":2,"issue_type":"task","assignee":"epic:claudeforge-central","created_at":"2026-01-08T13:47:50.044990987-08:00","created_by":"kingcu","updated_at":"2026-01-08T16:02:33.216292816-08:00","closed_at":"2026-01-08T16:02:33.216292816-08:00","close_reason":"Implemented all modules as per plan","dependencies":[{"issue_id":"claudeforge-gkf","depends_on_id":"claudeforge-68x","type":"parent-child","created_at":"2026-01-08T13:47:55.548967533-08:00","created_by":"kingcu"},{"issue_id":"claudeforge-gkf","depends_on_id":"claudeforge-sn8","type":"blocks","created_at":"2026-01-08T13:47:55.60050663-08:00","created_by":"kingcu"},{"issue_id":"claudeforge-gkf","depends_on_id":"claudeforge-4z6","type":"blocks","created_at":"2026-01-08T13:47:55.652870149-08:00","created_by":"kingcu"}]}
{"id":"claudeforge-jkf","title":"Implement HTTP sync logic (sync.py)","description":"Create sync logic module for client-server communication.\n\n**Context**: Handles the actual HTTP communication with the server, including auto-sync logic and error handling.\n\n**Classes/Functions** (see plan lines 857-979):\n\n1. SyncResult dataclass:\n   - status: str (\"success\", \"queued\", \"skipped\", \"error\")\n   - message: str = \"\"\n   - records_synced: int = 0\n\n2. parse_datetime(s: str) -\u003e datetime:\n   - Parse ISO format with timezone handling\n   - Handle \"Z\" suffix\n\n3. maybe_auto_sync(force: bool = False) -\u003e SyncResult:\n   - Return \"skipped\" if server_url not configured\n   - Return \"skipped\" if api_key not configured\n   - Return \"skipped\" if last_sync \u003c 1 hour ago (unless force)\n   - Otherwise call do_sync()\n\n4. do_sync(config: dict) -\u003e SyncResult:\n   - First: process_pending_syncs() to clear queue\n   - Build payload via build_sync_payload()\n   - POST to /v1/sync with X-API-Key header\n   - On success: update config with last_sync, return \"success\"\n   - On httpx.RequestError: queue_sync(), return \"queued\"\n   - On httpx.HTTPStatusError: return \"error\"\n\n5. fetch_daily_stats(days: int = 30) -\u003e list[dict] | None:\n   - GET /v1/stats/daily?days=N\n   - Cache response via save_server_data()\n   - Return None on failure\n\n**Constants**:\n- SYNC_TIMEOUT = 30.0 seconds\n\n**Auto-sync logic**:\n- Triggers on `forge tokens` (not `forge tokens --local`)\n- Only syncs if last_sync \u003e 1 hour ago\n- force=True bypasses time check\n\n**Success criteria**:\n1. maybe_auto_sync() returns \"skipped\" when unconfigured\n2. maybe_auto_sync() returns \"skipped\" when recently synced\n3. do_sync() returns \"success\" when server responds 200\n4. do_sync() returns \"queued\" on network error\n5. do_sync() returns \"error\" on HTTP 4xx/5xx\n6. fetch_daily_stats() returns None on failure (doesn't crash)\n","status":"closed","priority":2,"issue_type":"task","assignee":"epic:claudeforge-central","created_at":"2026-01-08T13:48:42.433620756-08:00","created_by":"kingcu","updated_at":"2026-01-08T16:04:44.784122825-08:00","closed_at":"2026-01-08T16:04:44.784122825-08:00","close_reason":"Implemented all router and sync modules","dependencies":[{"issue_id":"claudeforge-jkf","depends_on_id":"claudeforge-68x","type":"parent-child","created_at":"2026-01-08T13:48:49.230863788-08:00","created_by":"kingcu"},{"issue_id":"claudeforge-jkf","depends_on_id":"claudeforge-sn8","type":"blocks","created_at":"2026-01-08T13:48:49.284188183-08:00","created_by":"kingcu"},{"issue_id":"claudeforge-jkf","depends_on_id":"claudeforge-gkf","type":"blocks","created_at":"2026-01-08T13:48:49.337570855-08:00","created_by":"kingcu"},{"issue_id":"claudeforge-jkf","depends_on_id":"claudeforge-75h","type":"blocks","created_at":"2026-01-08T13:48:49.391029583-08:00","created_by":"kingcu"},{"issue_id":"claudeforge-jkf","depends_on_id":"claudeforge-87z","type":"blocks","created_at":"2026-01-08T13:48:49.444869119-08:00","created_by":"kingcu"}]}
{"id":"claudeforge-mcz","title":"Implement FastAPI application entry point (main.py)","description":"Create main FastAPI application that assembles all components.\n\n**Context**: This is the entry point for the server. It initializes the database on startup and registers all routers with authentication.\n\n**Implementation** (see plan lines 1251-1316):\n\n```python\nimport logging, sys\nfrom fastapi import FastAPI, Depends\nfrom fastapi.middleware.cors import CORSMiddleware\n\nfrom .db import init_db, get_db\nfrom .auth import verify_api_key\nfrom .models import HealthResponse\nfrom .routers import sync, stats, machines\n\nlogging.basicConfig(\n    level=logging.INFO,\n    format=\"%(asctime)s [%(levelname)s] %(name)s: %(message)s\",\n    stream=sys.stdout\n)\nlogger = logging.getLogger(__name__)\n\napp = FastAPI(\n    title=\"Forge Server\",\n    version=\"0.1.0\",\n    description=\"Central server for Claude Code usage tracking\"\n)\n\napp.add_middleware(\n    CORSMiddleware,\n    allow_origins=[\"*\"],\n    allow_credentials=True,\n    allow_methods=[\"*\"],\n    allow_headers=[\"*\"],\n)\n\n@app.on_event(\"startup\")\nasync def startup():\n    init_db()\n    logger.info(\"Database initialized\")\n\n@app.get(\"/health\", response_model=HealthResponse)\nasync def health_check():\n    # Query schema_version to verify DB connectivity\n    # Return healthy/unhealthy based on success\n\n# Register routers with auth dependency\napp.include_router(sync.router, prefix=\"/v1\", dependencies=[Depends(verify_api_key)])\napp.include_router(stats.router, prefix=\"/v1\", dependencies=[Depends(verify_api_key)])\napp.include_router(machines.router, prefix=\"/v1\", dependencies=[Depends(verify_api_key)])\n```\n\n**Key points**:\n- /health has NO auth (for monitoring/healthchecks)\n- All /v1/* routes require auth via Depends(verify_api_key)\n- CORS allows all origins (private API, behind Tailscale)\n- Database initialized on startup event\n\n**Success criteria**:\n1. `uvicorn forgeserver.main:app` starts without errors\n2. GET /health returns 200 without auth\n3. GET /health returns {\"status\": \"healthy\", \"database\": \"connected\", \"schema_version\": 1}\n4. All /v1/* endpoints return 401/422 without auth\n5. OpenAPI docs available at /docs\n6. Logs show \"Database initialized\" on startup\n","status":"closed","priority":2,"issue_type":"task","assignee":"epic:claudeforge-central","created_at":"2026-01-08T13:46:43.390014127-08:00","created_by":"kingcu","updated_at":"2026-01-08T16:05:35.800537417-08:00","closed_at":"2026-01-08T16:05:35.800537417-08:00","close_reason":"Implemented main.py and cli.py modules","dependencies":[{"issue_id":"claudeforge-mcz","depends_on_id":"claudeforge-68x","type":"parent-child","created_at":"2026-01-08T13:46:50.967594718-08:00","created_by":"kingcu"},{"issue_id":"claudeforge-mcz","depends_on_id":"claudeforge-sn8","type":"blocks","created_at":"2026-01-08T13:46:51.020740624-08:00","created_by":"kingcu"},{"issue_id":"claudeforge-mcz","depends_on_id":"claudeforge-ds2","type":"blocks","created_at":"2026-01-08T13:46:51.073870641-08:00","created_by":"kingcu"},{"issue_id":"claudeforge-mcz","depends_on_id":"claudeforge-e7r","type":"blocks","created_at":"2026-01-08T13:46:51.126629261-08:00","created_by":"kingcu"},{"issue_id":"claudeforge-mcz","depends_on_id":"claudeforge-n8m","type":"blocks","created_at":"2026-01-08T13:46:51.178993895-08:00","created_by":"kingcu"},{"issue_id":"claudeforge-mcz","depends_on_id":"claudeforge-ve5","type":"blocks","created_at":"2026-01-08T13:46:51.231889144-08:00","created_by":"kingcu"}]}
{"id":"claudeforge-n8m","title":"Implement /v1/machines/* endpoints (routers/machines.py)","description":"Create machines router for machine management (soft/hard delete, reactivate).\n\n**Context**: Allows managing registered machines without losing historical data (soft delete) or permanently removing them (hard delete).\n\n**Endpoints** (see plan lines 1482-1509):\n\n1. DELETE /v1/machines/{hostname}?hard=false\n   - hard=False (default): Soft delete - sets is_active=0, data preserved\n   - hard=True: Hard delete - CASCADE removes machine and all associated records\n   - Returns: {\"status\": \"deleted\", \"hard\": bool}\n   - 404 if hostname not found\n\n2. POST /v1/machines/{hostname}/reactivate\n   - Sets is_active=1 for soft-deleted machine\n   - Returns: {\"status\": \"reactivated\"}\n   - 404 if hostname not found\n\n**Implementation**:\n```python\nrouter = APIRouter(prefix=\"/machines\", tags=[\"machines\"])\n\n@router.delete(\"/{hostname}\")\nasync def remove_machine(hostname: str, hard: bool = Query(default=False)):\n    if delete_machine(hostname, hard=hard):\n        return {\"status\": \"deleted\", \"hard\": hard}\n    raise HTTPException(status_code=404, detail=\"Machine not found\")\n\n@router.post(\"/{hostname}/reactivate\")\nasync def reactivate(hostname: str):\n    if reactivate_machine(hostname):\n        return {\"status\": \"reactivated\"}\n    raise HTTPException(status_code=404, detail=\"Machine not found\")\n```\n\n**Use cases**:\n- Soft delete: Temporarily exclude a machine from stats (e.g., sold laptop)\n- Hard delete: Permanently remove test data or old machines\n- Reactivate: Restore a soft-deleted machine\n\n**Success criteria**:\n1. DELETE without hard param soft-deletes (is_active=0)\n2. DELETE with hard=true removes machine and all child records\n3. Soft-deleted machine excluded from stats queries\n4. POST reactivate restores is_active=1\n5. 404 returned for non-existent hostname on both endpoints\n6. Syncing from soft-deleted machine reactivates it automatically (via sync_usage)\n","status":"closed","priority":2,"issue_type":"task","assignee":"epic:claudeforge-central","created_at":"2026-01-08T13:46:25.410294948-08:00","created_by":"kingcu","updated_at":"2026-01-08T16:04:44.782940684-08:00","closed_at":"2026-01-08T16:04:44.782940684-08:00","close_reason":"Implemented all router and sync modules","dependencies":[{"issue_id":"claudeforge-n8m","depends_on_id":"claudeforge-68x","type":"parent-child","created_at":"2026-01-08T13:46:31.962375031-08:00","created_by":"kingcu"},{"issue_id":"claudeforge-n8m","depends_on_id":"claudeforge-sn8","type":"blocks","created_at":"2026-01-08T13:46:32.015294583-08:00","created_by":"kingcu"},{"issue_id":"claudeforge-n8m","depends_on_id":"claudeforge-dgp","type":"blocks","created_at":"2026-01-08T13:46:32.067030987-08:00","created_by":"kingcu"}]}
{"id":"claudeforge-qhw","title":"Remove legacy TypeScript files","description":"Remove the original TypeScript implementation before building Python version.\n\n**Context**: The project pivoted from TypeScript to Python. The src/ directory contains legacy code that conflicts with the new Python structure.\n\n**IMPORTANT**: This must run FIRST before creating server/ or client/ directories to avoid confusion.\n\n**Files to remove**:\n- src/*.ts (db.ts, graph.ts, cli.ts, index.ts, api.ts, claude-code.ts)\n- tsconfig.json\n- package.json\n- package-lock.json\n- dist/ directory (compiled JS)\n- node_modules/ (if exists)\n\n**Commands**:\n```bash\nrm -rf src/ dist/ node_modules/\nrm -f tsconfig.json package.json package-lock.json\n```\n\n**Decision**: Delete rather than archive because:\n- Python implementation is complete replacement\n- Git history preserves the TypeScript code if ever needed\n- No value in keeping dead code around\n\n**Success criteria**:\n1. No .ts files remain in project root\n2. No tsconfig.json or package.json\n3. src/ directory deleted\n4. `ls` shows only .beads/ and plan files\n5. Ready for Python server/ and client/ directories\n","status":"closed","priority":2,"issue_type":"chore","assignee":"epic:claudeforge-central","created_at":"2026-01-08T13:50:24.799506718-08:00","created_by":"kingcu","updated_at":"2026-01-08T16:00:34.394345828-08:00","closed_at":"2026-01-08T16:00:34.394345828-08:00","close_reason":"Removed src/, dist/, node_modules/, tsconfig.json, package.json, package-lock.json. Only .beads/ and AGENTS.md remain.","dependencies":[{"issue_id":"claudeforge-qhw","depends_on_id":"claudeforge-68x","type":"parent-child","created_at":"2026-01-08T13:50:30.875717685-08:00","created_by":"kingcu"},{"issue_id":"claudeforge-qhw","depends_on_id":"claudeforge-sn8","type":"blocks","created_at":"2026-01-08T13:50:30.930896379-08:00","created_by":"kingcu"}]}
{"id":"claudeforge-sn8","title":"GATE: Refinement for claudeforge-central","description":"REFINEMENT_STATE|iteration=5|last_refined=2026-01-08T15:52:23-08:00\n\nThis gate blocks all execution beads. Run /refine_beads to refine, or /execute_beads to begin.","status":"closed","priority":2,"issue_type":"chore","assignee":"epic:claudeforge-central","created_at":"2026-01-08T13:44:23.253184577-08:00","created_by":"kingcu","updated_at":"2026-01-08T15:59:55.010341134-08:00","closed_at":"2026-01-08T15:59:55.010341134-08:00","close_reason":"Completed: Refinement finished after 5 rounds.","dependencies":[{"issue_id":"claudeforge-sn8","depends_on_id":"claudeforge-68x","type":"parent-child","created_at":"2026-01-08T13:44:28.307971032-08:00","created_by":"kingcu"}]}
{"id":"claudeforge-ve5","title":"Implement server API key authentication (auth.py)","description":"Create authentication module with API key verification and rate limiting.\n\n**Context**: All API endpoints (except /health) require authentication. This provides basic security for the private API.\n\n**Environment variable**: FORGE_API_KEY (required for server to start accepting authenticated requests)\n\n**Implementation** (see plan lines 152-183):\n\n```python\nfrom fastapi import HTTPException, Security, Request\nfrom fastapi.security import APIKeyHeader\nimport os, time, secrets\n\napi_key_header = APIKeyHeader(name=\"X-API-Key\")\nrequest_counts: dict[str, list[float]] = {}\nRATE_LIMIT = 60  # requests per minute\n```\n\n**verify_api_key(request, api_key) async function**:\n1. Get expected key from os.environ.get(\"FORGE_API_KEY\")\n2. If not set: raise HTTPException(500, \"Server API key not configured\")\n3. Compare using secrets.compare_digest(api_key, expected)\n4. If mismatch: raise HTTPException(401, \"Invalid API key\")\n5. Rate limiting:\n   - Get client_ip from request.client.host (or \"unknown\")\n   - Clean up timestamps older than 60 seconds\n   - If len \u003e= RATE_LIMIT: raise HTTPException(429, \"Rate limit exceeded\")\n   - Append current timestamp\n6. Return api_key\n\n**Security considerations**:\n- secrets.compare_digest prevents timing attacks (constant-time comparison)\n- In-memory rate limiting (resets on restart, but acceptable for private API)\n- 401 for invalid key (not 403) per HTTP semantics\n\n**Pitfalls**:\n- Using == instead of secrets.compare_digest (timing attack vulnerability)\n- Forgetting to handle request.client being None (some reverse proxy configs)\n- Not cleaning up old timestamps (memory leak over time)\n\n**Success criteria**:\n1. Request without X-API-Key header returns 401 or 422\n2. Request with wrong key returns 401\n3. Request with correct key succeeds (200)\n4. 61 rapid requests from same IP triggers 429\n5. After 60 seconds, rate limit resets\n6. Server without FORGE_API_KEY env var returns 500 on any authed endpoint\n","status":"closed","priority":2,"issue_type":"task","assignee":"epic:claudeforge-central","created_at":"2026-01-08T13:45:34.092760987-08:00","created_by":"kingcu","updated_at":"2026-01-08T16:02:33.215188175-08:00","closed_at":"2026-01-08T16:02:33.215188175-08:00","close_reason":"Implemented all modules as per plan","dependencies":[{"issue_id":"claudeforge-ve5","depends_on_id":"claudeforge-68x","type":"parent-child","created_at":"2026-01-08T13:45:40.913202878-08:00","created_by":"kingcu"},{"issue_id":"claudeforge-ve5","depends_on_id":"claudeforge-sn8","type":"blocks","created_at":"2026-01-08T13:45:40.966045211-08:00","created_by":"kingcu"},{"issue_id":"claudeforge-ve5","depends_on_id":"claudeforge-b6n","type":"blocks","created_at":"2026-01-08T13:45:41.019460519-08:00","created_by":"kingcu"}]}
{"id":"claudeforge-xxp","title":"Run end-to-end integration tests","description":"Verify complete end-to-end workflow from client to server.\n\n**Context**: Final validation that all components work together correctly. This is a manual test checklist to run after all code is complete.\n\n**Prerequisites**:\n- Server code complete (Dockerfile builds)\n- Client code complete (`forge` command works)\n- docker-compose.yml and .env configured\n\n**Test procedure** (13 steps):\n\n**1. Server startup**:\n```bash\ncp .env.example .env\n# Edit .env to set FORGE_API_KEY (use: openssl rand -hex 32)\ndocker compose up -d\ndocker compose logs -f forgeserver  # Watch for \"Database initialized\"\n```\n\n**2. Health check**:\n```bash\ncurl http://localhost:8420/health\n# Expected: {\"status\":\"healthy\",\"database\":\"connected\",\"schema_version\":1}\n```\n\n**3. Auth verification**:\n```bash\ncurl http://localhost:8420/v1/stats/daily\n# Expected: 401 or 403 (no auth)\ncurl -H \"X-API-Key: wrong\" http://localhost:8420/v1/stats/daily\n# Expected: 401 (wrong key)\n```\n\n**4. Client installation**:\n```bash\npip install -e ./client\nforge --help\n# Expected: Shows commands (config, sync, tokens, etc.)\n```\n\n**5. Client configuration**:\n```bash\nforge config set server-url http://localhost:8420\nforge config set api-key YOUR_KEY_FROM_ENV\nforge config show\n# Expected: Shows server_url, api_key (masked), etc.\n```\n\n**6. First sync**:\n```bash\nforge sync --force\n# Expected: \"✓ Synced N records\" (N depends on local stats)\n```\n\n**7. Idempotent sync**:\n```bash\nforge sync --force\n# Expected: Same \"✓ Synced N records\" (idempotent)\n```\n\n**8. View aggregated stats**:\n```bash\nforge tokens\n# Expected: Graph showing usage, summary stats\n```\n\n**9. View local-only stats**:\n```bash\nforge tokens --local\n# Expected: Graph with \"Local Usage\" title, no server contact\n```\n\n**10. Offline queue**:\n```bash\ndocker compose stop forgeserver\nforge sync\n# Expected: \"⚠ Server unreachable (queued for retry)\"\n```\n\n**11. Check pending**:\n```bash\nforge sync --status\n# Expected: \"Pending syncs: 1\" (or more)\n```\n\n**12. Retry pending**:\n```bash\ndocker compose start forgeserver\nsleep 5\nforge sync --retry\n# Expected: \"Processed 1 pending syncs\"\n```\n\n**13. Verify data in server**:\n```bash\ncurl -H \"X-API-Key: YOUR_KEY\" http://localhost:8420/v1/stats/totals\n# Expected: Shows total_tokens, total_messages, machine_count \u003e= 1\n```\n\n**Success criteria**:\n1. All 13 steps pass without errors\n2. Server logs show incoming POST /v1/sync requests\n3. Data synced from client visible in server stats\n4. Graph renders correctly with bars and summary\n5. Offline queue drains correctly on retry\n6. Multiple forge sync calls are idempotent\n","status":"closed","priority":2,"issue_type":"task","assignee":"epic:claudeforge-central","created_at":"2026-01-08T13:50:07.779881809-08:00","created_by":"kingcu","updated_at":"2026-01-08T16:13:21.603975328-08:00","closed_at":"2026-01-08T16:13:21.603975328-08:00","close_reason":"All tests pass: 10 server tests, 10 client tests. CLI works. Implementation complete.","dependencies":[{"issue_id":"claudeforge-xxp","depends_on_id":"claudeforge-68x","type":"parent-child","created_at":"2026-01-08T13:50:14.372809766-08:00","created_by":"kingcu"},{"issue_id":"claudeforge-xxp","depends_on_id":"claudeforge-sn8","type":"blocks","created_at":"2026-01-08T13:50:14.427927049-08:00","created_by":"kingcu"},{"issue_id":"claudeforge-xxp","depends_on_id":"claudeforge-5qo","type":"blocks","created_at":"2026-01-08T13:50:14.482111718-08:00","created_by":"kingcu"},{"issue_id":"claudeforge-xxp","depends_on_id":"claudeforge-77w","type":"blocks","created_at":"2026-01-08T13:50:14.536558644-08:00","created_by":"kingcu"},{"issue_id":"claudeforge-xxp","depends_on_id":"claudeforge-fqu","type":"blocks","created_at":"2026-01-08T13:50:14.590538933-08:00","created_by":"kingcu"}]}
